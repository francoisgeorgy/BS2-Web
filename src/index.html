<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bass Station II Web Interface</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto|Roboto+Condensed:400,700" rel="stylesheet">
    <link rel="stylesheet" media="all" href="css/layout.css" />
    <!--<link rel="stylesheet" href="css/spectre.min.css" />-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="lib/webmidi.min.js"></script>
    <script src="lib/jquery.knob.min.js"></script>
    <script src="bs2.js"></script>
    <style>
        div.control {
            float: left;
            width: 60px;
            text-align: center;
            margin: 0 5px 5px 0;
        }
        div.double {
            width: 125px;
        }
        div.control > label {
            display: block;
            margin-top:-10px;
            font-size: 0.8em;
            color: #999;
        }
        /*div.label {
            background-color: yellow;
            margin-top:-10px;
        }*/
        .group:after {
            content: "";
            display: table;
            clear: both;
        }
        .spacer {
            float: left;
            width: 10px;
        }
    </style>
</head>
<body>
    <header></header>
    <main>
        <div>
            <h1>Sub</h1>
            <div>
                Octave
                Form
            </div>
        </div>
        <div>
            <h1>Mixer</h1>
            <div>
                <div class="control">
                    <input id="cc-111027" class="dial" data-width="60" data-height="60" value="0" />
                    <label>Sub</label>
                </div>
            </div>
        </div>
        <div>
            <h2>Effects</h2>
            <div>
            </div>
        </div>
        <div>5
        </div>
        <div>0
        </div>


        <div>
            <h1>Osc 1</h1>
            <div>
                <div class="group">
                    <div class="control double">
                        -RANGE-
                    </div>
                    <div class="spacer">&nbsp;</div>
                    <div class="control double">
                        -FORM-
                    </div>
                </div>
                <div class="group">
                    <div class="control">
                        <input id="cc-27" class="dial" data-width="60" data-height="60" value="0" />
                        <label>Coarse</label>
                    </div>
                    <div class="control">
                        <input id="cc-26" class="dial" data-width="60" data-height="60" value="0" />
                        <label>Fine</label>
                    </div>
                    <div class="spacer">&nbsp;</div>
                    <div class="control double">
                        <input id="cc-74" class="dial" data-width="60" data-height="60" value="0" />
                        <label>Man PW</label>
                    </div>
                </div>
                <div class="group">
                    <div class="control">
                        <input id="cc-71" class="dial" data-width="60" data-height="60" value="0" />
                        <label>Mod Env</label>
                    </div>
                    <div class="control">
                        <input id="cc-28" class="dial" data-width="60" data-height="60" value="0" />
                        <label>LFO 1</label>
                    </div>
                    <div class="spacer">&nbsp;</div>
                    <div class="control">
                        <input id="cc-72" class="dial" data-width="60" data-height="60" value="0" />
                        <label>Mod Env PW</label>
                    </div>
                    <div class="control">
                        <input id="cc-73" class="dial" data-width="60" data-height="60" value="0" />
                        <label>LFO2 2 PW</label>
                    </div>
                </div>
            </div>
        </div>

        <div>
            <div class="control">
                <input id="cc-a111027" class="dial" data-width="60" data-height="60" value="0" />
                <label>Osc 1</label>
            </div>
        </div>

        <div>4
        </div>

        <div>5
        </div>
        <div>1
        </div>


        <div>
            <h1>Osc 2</h1>
            <div>
                <div class="group">
                    <div class="control double">
                        -RANGE-
                    </div>
                    <div class="spacer">&nbsp;</div>
                    <div class="control double">
                        -FORM-
                    </div>
                </div>
                <div class="group">
                    <div class="control">
                        <input id="cc-027" class="dial" data-width="60" data-height="60" value="0" />
                        <label>Coarse</label>
                    </div>
                    <div class="control">
                        <input id="cc-026" class="dial" data-width="60" data-height="60" value="0" />
                        <label>Fine</label>
                    </div>
                    <div class="spacer">&nbsp;</div>
                    <div class="control double">
                        <input id="cc-074" class="dial" data-width="60" data-height="60" value="0" />
                        <label>Man PW</label>
                    </div>
                </div>
                <div class="group">
                    <div class="control">
                        <input id="cc-071" class="dial" data-width="60" data-height="60" value="0" />
                        <label>Mod Env</label>
                    </div>
                    <div class="control">
                        <input id="cc-028" class="dial" data-width="60" data-height="60" value="0" />
                        <label>LFO 1</label>
                    </div>
                    <div class="spacer">&nbsp;</div>
                    <div class="control">
                        <input id="cc-072" class="dial" data-width="60" data-height="60" value="0" />
                        <label>Mod Env PW</label>
                    </div>
                    <div class="control">
                        <input id="cc-073" class="dial" data-width="60" data-height="60" value="0" />
                        <label>LFO2 2 PW</label>
                    </div>
                </div>
            </div>
        </div> <!-- / OSC 2-->

        <div>
            <div>
                <div class="control">
                    <input id="cc-b111027" class="dial" data-width="60" data-height="60" value="0" />
                    <label>Osc 2</label>
                </div>
            </div>
        </div>
        <div>
            <h1>Filter</h1>
            <div>

            </div>
        </div>
        <div>
            <h1>Amplifier</h1>
            <div>
            </div>
        </div>

        <div>
        </div>


        <div>
            <h1>LFO 1, LFO 2</h1>
            <div>

            </div>
        </div>
        <div>
            <h1>Overdrive</h1>

            <div>

            </div>
        </div>
        <div>
            <h1>Mod Env</h1>
            <div>
                <div class="group">
                    <div class="control">
                        <input id="cc-1027" class="dial" data-width="60" data-height="60" value="0" />
                        <label>A</label>
                    </div>
                    <div class="control">
                        <input id="cc-1026" class="dial" data-width="60" data-height="60" value="0" />
                        <label>D</label>
                    </div>
                    <div class="control">
                        <input id="cc-11027" class="dial" data-width="60" data-height="60" value="0" />
                        <label>S</label>
                    </div>
                    <div class="control">
                        <input id="cc-11026" class="dial" data-width="60" data-height="60" value="0" />
                        <label>R</label>
                    </div>
                </div>
            </div>
        </div>
        <div>
            <h1>Amp Env</h1>
            <div>
                <div class="control">
                    <input id="cc-11027" class="dial" data-width="60" data-height="60" value="0" />
                    <label>A</label>
                </div>
                <div class="control">
                    <input id="cc-11026" class="dial" data-width="60" data-height="60" value="0" />
                    <label>D</label>
                </div>
                <div class="control">
                    <input id="cc-111027" class="dial" data-width="60" data-height="60" value="0" />
                    <label>S</label>
                </div>
                <div class="control">
                    <input id="cc-111026" class="dial" data-width="60" data-height="60" value="0" />
                    <label>R</label>
                </div>
            </div>
        </div>
        <div>
            <div>
            </div>
        </div>
    </main>
    <footer></footer>
    <script>



        function dispatch(type, control, value) {
            type = type.toLowerCase();
            console.log(type, control, value, '#' + type + '-' + control);
            if ((type != 'cc') && (type != 'nrpn')) return; //TODO: signal an error
//            if (control == 27) value = value * 10;
            $('#' + type + '-' + control).val(value).trigger('change');
        }



        //TODO: put into BS2 object
        function doubleByteValue(msb, lsb) {
            let v = msb << 1;
            return lsb > 0 ? (v+1) : v;
        }

        var cc_expected = -1;
        var cc_msb = -1;
        var cc_lsb = -1;
        var value_msb = 0;    // msb to compute value
        var value_lsb = 0;    // lsb to compute value

        var nrpn = false;

        function handleCC(e) {

            var msg = e.data;   // Uint8Array
            let cc = msg[1];

            let value = -1;

            if (cc == WebMidi.MIDI_CONTROL_CHANGE_MESSAGES['nonregisteredparameterfine']) {   // 99
                cc_msb = msg[2];
                nrpn = true;
                return;
            } else if (cc == WebMidi.MIDI_CONTROL_CHANGE_MESSAGES['nonregisteredparametercoarse']) {  // 98
                cc_lsb = msg[2];
                return;
            } else {
                if (nrpn) {
                    value = msg[2];
                    let v = value;
                    let r;
                    if (BS2.nrpn[cc_lsb].hasOwnProperty('map')) {
                        r = BS2.nrpn[cc_lsb].map(v);
//                        log_value(`${BS2.nrpn[cc_lsb].name} = ${r} (${v})`);
                    } else {
                        r = v;
//                        log_value(`${BS2.nrpn[cc_lsb].name} = ${v}`);
                    }
                    dispatch('NRPN', cc_lsb, r);
                    nrpn = false;
                    return;
                }
            }

            if (cc_expected >= 0) {
                if (cc == cc_expected) {
//                    console.log(`got expected cc ${cc}, cc_msb=${cc_msb}`);

                    value_lsb = msg[2];

                    let v = doubleByteValue(value_msb, value_lsb);
                    let r;
                    if (BS2.control[cc_msb].hasOwnProperty('map')) {
                        r = BS2.control[cc_msb].map(v);
//                        log_value(`${BS2.control[cc_msb].name} = ${r} (${v})`);
                    } else {
                        r = v;
//                        log_value(`${BS2.control[cc_msb].name} = ${v}`);
                    }
                    dispatch('CC', cc_msb, r);

                    cc_expected = -1;

                } else {
//                    log(`IGNORED CC ${cc}`);
                    cc_msb = cc;
                }
            } else {

                if (BS2.control[cc].lsb == -1) {
                    let v = msg[2];
                    let r;
                    if (BS2.control[cc].hasOwnProperty('map')) {
                        r = BS2.control[cc].map(v);
                        //log_value(`${CC_names[cc]} = ${r} (${v})`);
//                        log_value(`${BS2.control[cc]} = ${r} (${v})`);
                    } else {
//                        log_value(`${BS2.control[cc].name} = ${v}`);
                        r = v;
                    }

                    dispatch('CC', cc, r);

                } else {
//                    console.log('need second CC ' + BS2.control[cc].lsb);
                    cc_expected = BS2.control[cc].lsb;
                    cc_msb = cc;
                    value_msb = msg[2];
                }
            }
        }

        function setUpDials() {

            $(".dial").knob({
                change : function (v) { console.log('change', v); },
                release : function (v) { console.log('release', v); },
//                fgColor:"#FF0000",
                angleOffset: -135,
                angleArc: 270
            });

//            $(".dial").knob({
//                'min': -120,
//                'max': 120,
//                width: 60
//            });

            $("#cc-26").trigger('configure', { min: -100, max: 100 });
            $("#cc-27").trigger('configure', { min: -12.0, max: 12.0, step: 0.1 });
            $("#cc-28").trigger('configure', { min: -127, max: 127 });
            $("#cc-71").trigger('configure', { min: -63, max: 63 });
            $("#cc-72").trigger('configure', { min: -63, max: 63 });
            $("#cc-73").trigger('configure', { min: -90, max: 90 });
            $("#cc-74").trigger('configure', { min: 0, max: 95 });

        }

        $(function () {

            setUpDials();

            WebMidi.enable(function (err) {

                if (err) {
                    alert("WebMidi could not be enabled.", err);
                } else {

                //WebMidi.inputs.map(i => log("input:" + i.name));
                //WebMidi.outputs.map(i => log("output:" + i.name));

                var input = WebMidi.getInputByName("Bass Station II");

                input.on('controlchange', "all", function(e) {
                    //console.log("CC: ", e);
//                    log(midiEventForHuman(e));
                    handleCC(e);
                });

                //WebMidi.addListener("connected", e => logWebMidiEvent(e));
                //WebMidi.addListener("disconnected", e => logWebMidiEvent(e));

                }

            });


//            nx.onload = function () {
//                nx.colorize("#00CCFF"); // sets accent (default)
//                nx.labelSize(50);
        });


    </script>
</body>
</html>