<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bass Station II Web Interface</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto|Roboto+Condensed:400,700" rel="stylesheet">
    <link rel="stylesheet" media="all" href="css/layout.css" />
    <link rel="stylesheet" media="all" href="css/dark-theme.css" />
    <!--<link rel="stylesheet" href="css/spectre.min.css" />-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="lib/webmidi.min.js"></script>
    <script src="lib/jquery.knob.min.js"></script>
    <script src="bs2.js"></script>
</head>
<body>
    <main>

        <div class="head">
            Bass Station II Web Interface
            <div id="con-status">not connected</div>
        </div>

        <div class="box sub">
            <h1>Sub</h1>
            <div>
                <!--<label>Wave:</label>-->
                <select id="cc-80">
                </select>
                <label style="margin-left:10px">Octave:</label>
                <select id="cc-81">
                    <option>-1</option>
                    <option>-2</option>
                </select>
            </div>
        </div>

        <div class="box lfo1">
            <h1>LFO 1</h1>
            <div class="space-after">
                <!--<label>Wave:</label>-->
                <select id="cc-88">
                </select>
            </div>
            <div class="group">
                <div class="control row">
                    <input id="cc-86" class="dial" data-width="60" data-height="60" value="0" />
                    <label>Delay</label>
                </div>
            </div>
            <div class="group">
                <div class="control row">
                    <input id="cc-18" class="dial" data-width="60" data-height="60" value="0" />
                    <label>Speed</label>
                </div>
            </div>
            <div class="group space-after">
                <div class="control row">
                    <!--<label>Sync:</label>-->
                    <select>
                        <option>speed</option>
                        <option>sync</option>
                    </select>
                    <div class="value">sync val</div>
                </div>
            </div>
            <div class="group">
                <div class="control">
                    <input id="nrpn-86" class="dial" data-width="60" data-height="60" value="0" />
                    <label>Slew</label>
                </div>
            </div>
        </div>

        <div class="box lfo2">
            <h1>LFO 2</h1>
            <div class="space-after">
                <!--<label>Wave:</label>-->
                <select id="cc-89">
                </select>
            </div>
            <div class="group">
                <div class="control row">
                    <input id="cc-87" class="dial" data-width="60" data-height="60" value="0" />
                    <label>Delay</label>
                </div>
            </div>
            <div class="group">
                <div class="control row">
                    <input id="cc-19" class="dial" data-width="60" data-height="60" value="0" />
                    <label>Speed</label>
                </div>
                <!--<div class="control row" style="padding-top:10px">-->
                    <!--<label>Sync:</label>-->
                    <!--<select>-->
                        <!--<option>speed</option>-->
                        <!--<option>sync</option>-->
                    <!--</select>-->
                    <!--<div class="value">sync val</div>-->
                <!--</div>-->
            </div>
            <div class="group space-after">
                <div class="control row">
                    <select>
                        <option>speed</option>
                        <option>sync</option>
                    </select>
                    <div class="value">sync val</div>
                </div>
            </div>
            <div class="group">
                <div class="control">
                    <input id="nrpn-90" class="dial" data-width="60" data-height="60" value="0" />
                    <label>Slew</label>
                </div>
            </div>
        </div>

        <div class="box osc1">
            <h1>Osc 1</h1>
            <div>
                <div class="group left space-after">
                    <div class="control double">
                        <select id="cc-70">
                        </select>
                        <select id="nrpn-72">
                        </select>
                    </div>
                </div>
                <div class="group">
                    <div class="control row">
                        <input id="cc-27" class="dial" data-width="60" data-height="60" value="0" />
                        <label>Coarse</label>
                    </div>
                    <div class="control row">
                        <input id="cc-26" class="dial" data-width="60" data-height="60" value="0" />
                        <label>Fine</label>
                    </div>
                </div>
                <div class="group space-after">
                    <div class="control row">
                        <input id="cc-71" class="dial" data-width="60" data-height="60" value="0" />
                        <label>Mod Env</label>
                    </div>
                    <div class="control row">
                        <input id="cc-28" class="dial" data-width="60" data-height="60" value="0" />
                        <label>LFO 1</label>
                    </div>
                </div>
                <div class="group">
                    <div class="control row double">
                        <input id="cc-74" class="dial" data-width="60" data-height="60" value="0" />
                        <label>Man PW</label>
                    </div>
                </div>
                <div class="group">
                    <div class="control row">
                        <input id="cc-72" class="dial" data-width="60" data-height="60" value="0" />
                        <label>Mod Env PW</label>
                    </div>
                    <div class="control row">
                        <input id="cc-73" class="dial" data-width="60" data-height="60" value="0" />
                        <label>LFO2 2 PW</label>
                    </div>
                </div>
            </div>

        </div>

        <div class="box osc2">
            <h1>Osc 2</h1>
            <div>
                <div class="group left space-after">
                    <div class="control double">
                        <select id="cc-75">
                        </select>
                        <select id="nrpn-82">
                        </select>
                    </div>
                </div>
                <div class="group">
                    <div class="control row">
                        <input id="cc-30" class="dial" data-width="60" data-height="60" value="0" />
                        <label>Coarse</label>
                    </div>
                    <div class="control row">
                        <input id="cc-29" class="dial" data-width="60" data-height="60" value="0" />
                        <label>Fine</label>
                    </div>
                </div>
                <div class="group space-after">
                    <div class="control row">
                        <input id="cc-76" class="dial" data-width="60" data-height="60" value="0" />
                        <label>Mod Env</label>
                    </div>
                    <div class="control row">
                        <input id="cc-31" class="dial" data-width="60" data-height="60" value="0" />
                        <label>LFO 1</label>
                    </div>
                </div>
                <div class="group">
                    <div class="control row double">
                        <input id="cc-79" class="dial" data-width="60" data-height="60" value="0" />
                        <label>Man PW</label>
                    </div>
                </div>
                <div class="group">
                    <div class="control row">
                        <input id="cc-77" class="dial" data-width="60" data-height="60" value="0" />
                        <label>Mod Env PW</label>
                    </div>
                    <div class="control row">
                        <input id="cc-78" class="dial" data-width="60" data-height="60" value="0" />
                        <label>LFO2 2 PW</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="box mix">
            <h1>Mixer</h1>
            <div class="group left space-after">
                <div class="control">&nbsp;</div>
            </div>
            <div class="group">
                <div class="control row">
                    <input id="cc-22" class="dial" data-width="60" data-height="60" value="0" />
                    <label>Sub</label>
                </div>
                <div class="control row">
                    <input id="cc-20" class="dial" data-width="60" data-height="60" value="0" />
                    <label>Osc 1</label>
                </div>
                <div class="control row">
                    <input id="cc-21" class="dial" data-width="60" data-height="60" value="0" />
                    <label>Osc 2</label>
                </div>
            </div>

            <div class="group">
                <div class="control row">
                    <input id="cc-25" class="dial" data-width="60" data-height="60" value="0" />
                    <label>Ext</label>
                </div>
                <div class="control row">
                    <input id="cc-24" class="dial" data-width="60" data-height="60" value="0" />
                    <label>Ring</label>
                </div>
                <div class="control row">
                    <input id="cc-23" class="dial" data-width="60" data-height="60" value="0" />
                    <label>Noise</label>
                </div>
            </div>
        </div>

        <div class="box fil">
            <h1>Filter</h1>
            <div class="group space-after">
                <select id="cc-83">
                    <option>classic</option>
                    <option>acid</option>
                </select>
                <select id="cc-106">
                    <option>12dB</option>
                    <option>24dB</option>
                </select>
                <select id="cc-84">
                    <option>LP</option>
                    <option>BP</option>
                    <option>HP</option>
                </select>
            </div>
            <div class="group">
                <div class="control row">
                    <input id="cc-82" class="dial" data-width="60" data-height="60" value="0" />
                    <label>Reso</label>
                </div>
                <div class="control row">
                    <input id="cc-16" class="dial" data-width="60" data-height="60" value="0" />
                    <label>Freq</label>
                </div>
            </div>
            <div class="group">
                <div class="control row">
                    <input id="cc-114" class="dial" data-width="60" data-height="60" value="0" />
                    <label>Over</label>
                </div>
                <div class="control row">
                    <input id="cc-85" class="dial" data-width="60" data-height="60" value="0" />
                    <label>Mod</label>
                </div>
                <div class="control row">
                    <input id="cc-17" class="dial" data-width="60" data-height="60" value="0" />
                    <label>LFO 2</label>
                </div>
            </div>
        </div>

        <div class="box mod">
            <h1>Mod Env</h1>
            <div class="group space-after">
                <div class="control row">
                    <input id="cc-102" class="dial" data-width="60" data-height="60" value="0" />
                    <label>A</label>
                </div>
                <div class="control row">
                    <input id="cc-103" class="dial" data-width="60" data-height="60" value="0" />
                    <label>D</label>
                </div>
                <div class="control row">
                    <input id="cc-104" class="dial" data-width="60" data-height="60" value="0" />
                    <label>S</label>
                </div>
                <div class="control row">
                    <input id="cc-105" class="dial" data-width="60" data-height="60" value="0" />
                    <label>R</label>
                </div>
            </div>
            <label>Triggering:</label>
            <select id="aaaaaa">
                <option>Single</option>
                <option>Multi</option>
                <option>Autoglide</option>
            </select>
        </div>

        <div class="box amp">
            <h1>Amp Env</h1>
            <div class="group space-after">
                <div class="control row">
                    <input id="cc-90" class="dial" data-width="60" data-height="60" value="0"/>
                    <label>A</label>
                </div>
                <div class="control row">
                    <input id="cc-91" class="dial" data-width="60" data-height="60" value="0"/>
                    <label>D</label>
                </div>
                <div class="control row">
                    <input id="cc-92" class="dial" data-width="60" data-height="60" value="0"/>
                    <label>S</label>
                </div>
                <div class="control row">
                    <input id="cc-93" class="dial" data-width="60" data-height="60" value="0"/>
                    <label>R</label>
                </div>
            </div>
            <label>Triggering:</label>
            <select id="aaaaaa">
                <option>Single</option>
                <option>Multi</option>
                <option>Autoglide</option>
            </select>
        </div>

        <div class="wheels">
            <h1>Wheels</h1>
            <div class="group">
                <div class="control row">
                    <label>Mod Wheel</label>
                </div>
            </div>
        </div>

        <div class="keyboard">
            <h1>Keyboard</h1>
            <div class="group">
                <div class="control row">
                    <label>Aftertouch</label>
                </div>
                <div class="control row">
                    <label>Aftertouch</label>
                </div>
            </div>
        </div>

        <div class="other1">
        </div>

        <div class="other2">
        </div>

        <div class="status">
            Status messages...
        </div>


    </main>
    <footer></footer>
    <script>



        function dispatch(type, control, value) {
            type = type.toLowerCase();
            console.log(type, control, value, '#' + type + '-' + control);
            if ((type != 'cc') && (type != 'nrpn')) return; //TODO: signal an error
//            if (control == 27) value = value * 10;
            $('#' + type + '-' + control).val(value).trigger('change');
        }



        //TODO: put into BS2 object
        function doubleByteValue(msb, lsb) {
            let v = msb << 1;
            return lsb > 0 ? (v+1) : v;
        }

        var cc_expected = -1;
        var cc_msb = -1;
        var cc_lsb = -1;
        var value_msb = 0;    // msb to compute value
        var value_lsb = 0;    // lsb to compute value

        var nrpn = false;

        function handleCC(e) {

            var msg = e.data;   // Uint8Array
            let cc = msg[1];

            let value = -1;

            if (cc == WebMidi.MIDI_CONTROL_CHANGE_MESSAGES['nonregisteredparameterfine']) {   // 99
                cc_msb = msg[2];
                nrpn = true;
                return;
            } else if (cc == WebMidi.MIDI_CONTROL_CHANGE_MESSAGES['nonregisteredparametercoarse']) {  // 98
                cc_lsb = msg[2];
                return;
            } else {
                if (nrpn) {
                    value = msg[2];
                    let v = value;
                    let r;
                    if (BS2.nrpn[cc_lsb].hasOwnProperty('map')) {
                        r = BS2.nrpn[cc_lsb].map(v);
//                        log_value(`${BS2.nrpn[cc_lsb].name} = ${r} (${v})`);
                    } else {
                        r = v;
//                        log_value(`${BS2.nrpn[cc_lsb].name} = ${v}`);
                    }
                    dispatch('NRPN', cc_lsb, r);
                    nrpn = false;
                    return;
                }
            }

            if (cc_expected >= 0) {
                if (cc == cc_expected) {
//                    console.log(`got expected cc ${cc}, cc_msb=${cc_msb}`);

                    value_lsb = msg[2];

                    let v = doubleByteValue(value_msb, value_lsb);
                    let r;
                    if (BS2.control[cc_msb].hasOwnProperty('map')) {
                        r = BS2.control[cc_msb].map(v);
//                        log_value(`${BS2.control[cc_msb].name} = ${r} (${v})`);
                    } else {
                        r = v;
//                        log_value(`${BS2.control[cc_msb].name} = ${v}`);
                    }
                    dispatch('CC', cc_msb, r);

                    cc_expected = -1;

                } else {
//                    log(`IGNORED CC ${cc}`);
                    cc_msb = cc;
                }
            } else {

                if (BS2.control[cc].lsb == -1) {
                    let v = msg[2];
                    let r;
                    if (BS2.control[cc].hasOwnProperty('map')) {
                        r = BS2.control[cc].map(v);
                        //log_value(`${CC_names[cc]} = ${r} (${v})`);
//                        log_value(`${BS2.control[cc]} = ${r} (${v})`);
                    } else {
//                        log_value(`${BS2.control[cc].name} = ${v}`);
                        r = v;
                    }

                    dispatch('CC', cc, r);

                } else {
//                    console.log('need second CC ' + BS2.control[cc].lsb);
                    cc_expected = BS2.control[cc].lsb;
                    cc_msb = cc;
                    value_msb = msg[2];
                }
            }
        }

        /**
         * Set value of the dials
         */
        function setDials() {

            for (let i=0; i < BS2.control.length; i++) {

                let c = BS2.control[i];

                if (typeof c === 'undefined') continue;

                if (!c.hasOwnProperty('value')) continue;

                console.log(i, c.value);

                let e = $('#cc-' + i);
                if (e.hasClass('dial')) {
                    e.val(c.value).trigger('change');
                } else {
                    e.val(c.value);
                }
            }


            for (let i=0; i < BS2.nrpn.length; i++) {

                let c = BS2.nrpn[i];

                if (typeof c === 'undefined') continue;

                if (!c.hasOwnProperty('value')) continue;

                console.log(i, c.value);

                let e = $('#nrpn-' + i);
                if (e.hasClass('dial')) {
                    e.val(c.value).trigger('change');
                } else {
                    e.val(c.value);
                }
            }

        }

        function setupDials() {

            const CURSOR = 16;

            $(".dial").knob({
                change : function (v) { console.log('change', v); },
                release : function (v) { console.log('release', v); },
//                fgColor:"#FF0000",
                angleOffset: -135,
                angleArc: 270,
                bgColor: "#606060",
                fgColor: "#ffec03"
//                skin: "tron",
//                thickness:.2,
/*
                draw : function () {

                    // "tron" case
//                    if(this.$.data('skin') == 'tron') {

                        this.cursorExt = 0.3;

                        var a = this.arc(this.cv)  // Arc
                            , pa                   // Previous arc
                            , r = 1;

                        this.g.lineWidth = this.lineWidth;

                        if (this.o.displayPrevious) {
                            pa = this.arc(this.v);
                            this.g.beginPath();
                            this.g.strokeStyle = this.pColor;
                            this.g.arc(this.xy, this.xy, this.radius - this.lineWidth, pa.s, pa.e, pa.d);
                            this.g.stroke();
                        }

                        this.g.beginPath();
                        this.g.strokeStyle = r ? this.o.fgColor : this.fgColor ;
                        this.g.arc(this.xy, this.xy, this.radius - this.lineWidth, a.s, a.e, a.d);
                        this.g.stroke();

                        this.g.lineWidth = 2;
                        this.g.beginPath();
                        this.g.strokeStyle = this.o.fgColor;
                        this.g.arc( this.xy, this.xy, this.radius - this.lineWidth + 1 + this.lineWidth * 2 / 3, 0, 2 * Math.PI, false);
                        this.g.stroke();

                        return false;
                    }
//                } // draw
*/
            });

//            $(".dial").knob({
//                'min': -120,
//                'max': 120,
//                width: 60
//            });

            for (let i=0; i < BS2.control.length; i++) {

                let c = BS2.control[i];

                if (typeof c == 'undefined') continue;

                if (!c.hasOwnProperty('range')) continue;

                let id = '#cc-' + i;
                let min = c.range[0];
                let max = c.range[1];
                let cursor = min < 0 ? CURSOR : false;
                let step = 1;

                console.log(i, c, min, max, cursor);

                $(id).trigger('configure', { min: min, max: max, step: step, cursor: cursor });

                if (min > 0) {
                    $(id).val(min).trigger('change');
                }

            }

//                $("#cc-26").trigger('configure', { min: -100, max: 100, cursor: CURSOR });
//            $("#cc-27").trigger('configure', { min: -12.0, max: 12.0, step: 0.1, cursor: CURSOR });
//            $("#cc-28").trigger('configure', { min: -127, max: 127, cursor: CURSOR });
//            $("#cc-71").trigger('configure', { min: -63, max: 63, cursor: CURSOR });
//            $("#cc-72").trigger('configure', { min: -63, max: 63, cursor: CURSOR });
//            $("#cc-73").trigger('configure', { min: -90, max: 90 });
//            $("#cc-74").trigger('configure', { min: 0, max: 95 });

        }

        function setupLists() {

            $('#cc-80').append(
                BS2.SUB_WAVE_FORMS.map(o => { console.log(o); return $("<option>").val(o).text(o); })
            );
            $('#cc-88,#cc-89').append(
                BS2.LFO_WAVE_FORMS.map(o => { console.log(o); return $("<option>").val(o).text(o); })
            );
            $('#cc-70,#cc-75').append(
                BS2.OSC_RANGES.map(o => { console.log(o); return $("<option>").val(o).text(o); })
            );
            $('#nrpn-72,#nrpn-82').append(
                BS2.OSC_WAVE_FORMS.map(o => { console.log(o); return $("<option>").val(o).text(o); })
            );
        }

        $(function () {

            setupDials();
            setupLists();

            WebMidi.enable(function (err) {

                if (err) {
                    alert("WebMidi could not be enabled.", err);
                } else {

                //WebMidi.inputs.map(i => log("input:" + i.name));
                //WebMidi.outputs.map(i => log("output:" + i.name));

                var input = WebMidi.getInputByName("Bass Station II");

                input.on('controlchange', "all", function(e) {
                    //console.log("CC: ", e);
//                    log(midiEventForHuman(e));
                    handleCC(e);
                });

                input.on('sysex', "all", function(e) {
                    console.log("SysEx: ", e);
                    BS2.setValuesFromSysex(e.data);
                    console.log(BS2.control);
                    console.log(BS2.nrpn);
                    setDials();
                });

//                $('#nrpn-72').val('pulse');
//                console.log($('#nrpn-72').hasClass('dial'));
//                    console.log($('#cc-86').hasClass('dial'));


                    //WebMidi.addListener("connected", e => logWebMidiEvent(e));
                //WebMidi.addListener("disconnected", e => logWebMidiEvent(e));

                }

            }, true);   // pass true to enable sysex support


//            nx.onload = function () {
//                nx.colorize("#00CCFF"); // sets accent (default)
//                nx.labelSize(50);
        });


    </script>
</body>
</html>